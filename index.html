<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ricette & Lista Spesa</title>

  <link rel="icon" href="./favicon.ico">
  <link rel="manifest" href="./manifest.webmanifest?v=18">
  <link rel="preload" href="./styles.css?v=18" as="style">
  <link rel="stylesheet" href="./styles.css?v=18">

  <meta name="theme-color" content="#ffffff">
</head>
<body>
  <header class="app-header">
    <h1>Ricette & Lista Spesa</h1>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Cerca ricette">
      <button id="reloadData">Aggiorna dati</button>
      <button id="devToggle">Dev</button>
    </div>
  </header>

  <main id="app">
    <section id="cards" class="cards"></section>

    <section id="yt-audit" class="panel">
      <div class="panel-header">
        <h2>Verifica YouTube</h2>
        <div class="audit-filters">
          <span id="rowsTotal">Righe totali: 0</span>
          <button data-filter="all" class="chip chip--on">Tutte</button>
          <button data-filter="verified" class="chip">Verificate</button>
          <button data-filter="low" class="chip">Bassa conf.</button>
          <button data-filter="missing" class="chip">Mancanti</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table" id="ytTable">
          <thead>
            <tr>
              <th>Titolo ricetta</th>
              <th>youtubeId</th>
              <th>Titolo video</th>
              <th>Canale</th>
              <th>Conf.</th>
            </tr>
          </thead>
          <tbody id="ytBody">
            <tr><td colspan="5" class="muted">Caricamento…</td></tr>
          </tbody>
        </table>
        <div class="hint">Soglia verifica 0.25. Clic su Guarda video apre modale</div>
      </div>
    </section>

    <!-- Modale video -->
    <dialog id="videoModal">
      <div class="video-frame">
        <iframe id="ytFrame" src="" title="YouTube" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen referrerpolicy="origin-when-cross-origin"></iframe>
      </div>
      <button id="closeModal" class="btn">Chiudi</button>
      <a id="openExternal" target="_blank" rel="noopener" class="btn btn-alt">Apri su YouTube</a>
    </dialog>
  </main>

  <footer class="app-footer">Zero sprechi, più idee in cucina.</footer>

  <!-- App core -->
  <script src="./app.v16.js?v=18" defer></script>

  <!-- Audit YouTube opzionale: carica per ultimo, non blocca la UI -->
  <!-- Se serve, commenta la riga seguente -->
  <script src="assets/js/yt-audit.v2.js?v=19" defer></script>
          defer
          onerror="console.warn('yt-audit non caricato, UI ok');">
  </script>

  <!-- SW safe loader -->
  <script>
    // Bypass cache forte in sessione di debug
    if (location.search.includes('nocache=1')) {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(list => {
          for (const r of list) r.unregister();
        });
        caches && caches.keys && caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
      }
    }
    // Register SW normalmente
    if ('serviceWorker' in navigator && !location.search.includes('nosw=1')) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?v=18').catch(()=>{});
      });
    }
  </script>
</body>
</html>

