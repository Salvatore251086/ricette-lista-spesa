<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ricette & Lista Spesa</title>
  <meta name="description" content="Ricette veloci, lista spesa smart, video e strumenti utili per cucinare senza stress.">
  <meta name="theme-color" content="#111111">

  <!-- SEO base -->
  <link rel="canonical" href="/">
  <meta name="robots" content="index, follow">

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">

  <!-- Stili -->
  <link rel="stylesheet" href="styles.css?v=2025-10-27-2">
  <style>
    :root { color-scheme: light dark }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #0e0e0e; color: #f5f5f5 }
    a { color: #5cc8ff }
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(1.2) blur(6px); background: rgba(15,15,15,0.8); border-bottom: 1px solid rgba(255,255,255,0.06) }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 12px 16px }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: 0.2px }
    .brand img { width: 28px; height: 28px; border-radius: 6px }
    .toolbar { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap }
    .input { flex: 1 1 280px; display: flex; align-items: center; gap: 8px; background: #151515; border: 1px solid #272727; border-radius: 10px; padding: 10px 12px }
    .input input { width: 100%; background: transparent; color: inherit; border: 0; outline: 0; font-size: 15px }
    .chipbar { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0 }
    .chip { padding: 6px 10px; border-radius: 999px; background: #171717; border: 1px solid #2a2a2a; font-size: 13px; cursor: pointer; user-select: none }
    .chip.is-active { background: #0a84ff; border-color: #0a84ff; color: #fff }
    main { max-width: 1100px; margin: 0 auto; padding: 16px }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px }
    .card { background: #141414; border: 1px solid #262626; border-radius: 14px; overflow: hidden; display: flex; flex-direction: column }
    .thumb { aspect-ratio: 16/9; background: #000; position: relative }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block }
    .play { position: absolute; inset: 0; display: grid; place-items: center; background: linear-gradient(transparent, rgba(0,0,0,0.35)); opacity: 0; transition: opacity 180ms }
    .thumb:hover .play { opacity: 1 }
    .play button { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.24); color: #fff; padding: 8px 12px; border-radius: 999px; cursor: pointer }
    .body { padding: 12px }
    .title { font-weight: 600; line-height: 1.2; margin: 0 0 8px 0; font-size: 16px }
    .meta { font-size: 12px; color: #c7c7c7 }
    .empty { padding: 28px; text-align: center; color: #c7c7c7; border: 1px dashed #2a2a2a; border-radius: 12px }
    footer { max-width: 1100px; margin: 0 auto; padding: 24px 16px; color: #9a9a9a }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0 }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <img src="assets/icons/icon-64.png" alt="Logo">
        <span>Ricette & Lista Spesa</span>
      </div>

      <div class="toolbar">
        <label class="input" aria-label="Cerca ricette">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.2-4.2m1.7-5.3a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="q" type="search" placeholder="Cerca ingredienti o ricette">
        </label>
        <div class="chipbar" role="tablist" aria-label="Filtri rapide">
          <button class="chip is-active" data-chip="tutte" role="tab" aria-selected="true">Tutte</button>
          <button class="chip" data-chip="veloci" role="tab" aria-selected="false">Veloci</button>
          <button class="chip" data-chip="economiche" role="tab" aria-selected="false">Economiche</button>
          <button class="chip" data-chip="video" role="tab" aria-selected="false">Con video</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div id="results" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>Nessun risultato. Prova a rimuovere filtri o cerca una parola diversa.</div>
  </main>

  <footer>
    <small>V. <span id="appVersion">dev</span> • Funziona offline dove possibile</small>
  </footer>

  <!-- Versione build esposta presto per i log -->
  <script>
    window.APP_VERSION = 'rls-2025.10.27.2';
    document.addEventListener('DOMContentLoaded', function(){ 
      var v = document.getElementById('appVersion'); 
      if (v) v.textContent = window.APP_VERSION; 
    });
  </script>

  <!-- Debug e diagnostica -->
  <script src="script/debug-tools.v1.js?v=2025-10-27-2"></script>

  <!-- Modale video con fallback 153 -->
  <script src="script/video-modal.v3.js?v=2025-10-27-2"></script>

  <!-- App minima, idempotente -->
  <script>
    ;(() => {
      const S = {
        all: [],
        filtered: [],
        chips: new Set(['tutte']),
        search: ''
      };

      // Dataset minimo, sostituisci con fetch JSON locale
      const seed = [
        { id: 'r1', title: 'Pasta al tonno', tags: ['veloci'], videoId: 'dQw4w9WgXcQ', thumb: 'assets/screenshots/pasta-tonno.jpg' },
        { id: 'r2', title: 'Frittata di zucchine', tags: ['economiche'], videoId: '', thumb: 'assets/screenshots/frittata-zucchine.jpg' },
        { id: 'r3', title: 'Tiramisù classico', tags: ['video'], videoId: 'hY7m5jjJ9mM', thumb: 'assets/screenshots/tiramisu.jpg' }
      ];

      // Hook per debugTools
      window.getActiveChips = function () { return Array.from(S.chips); };
      window.getRecipeList = function () { return S.filtered.map(r => r.id); };
      window.getAppState = function () {
        return {
          network: navigator.onLine ? 'online' : 'offline',
          search: S.search,
          chips: Array.from(S.chips),
          counts: { all: S.all.length, filtered: S.filtered.length }
        };
      };

      // Init
      function init() {
        S.all = seed;
        bindUI();
        applyFilters();
      }

      function bindUI() {
        // Ricerca con debounce semplice
        const q = document.getElementById('q');
        let t = 0;
        q.addEventListener('input', function () {
          clearTimeout(t);
          const val = this.value.trim().toLowerCase();
          t = setTimeout(function () { S.search = val; applyFilters(); }, 180);
        });

        // Chip toggle esclusivo semplice
        document.addEventListener('click', function (e) {
          const chip = e.target.closest('.chip');
          if (!chip) return;
          document.querySelectorAll('.chip').forEach(c => c.classList.remove('is-active'));
          chip.classList.add('is-active');
          const tag = chip.getAttribute('data-chip');
          S.chips = new Set([tag]);
          applyFilters();
        });

        // Click su card per video se presente
        document.addEventListener('click', function (e) {
          const btn = e.target.closest('[data-video-id]');
          if (!btn) return;
          const id = btn.getAttribute('data-video-id');
          if (id) videoModal.open({ id });
        });
      }

      function applyFilters() {
        const tag = Array.from(S.chips)[0];
        const term = S.search;
        S.filtered = S.all.filter(function (r) {
          const byTag = tag === 'tutte' || r.tags.includes(tag);
          const byText = !term || r.title.toLowerCase().includes(term);
          return byTag && byText;
        });
        render();
      }

      function render() {
        const grid = document.getElementById('results');
        const empty = document.getElementById('empty');
        if (!grid) return;

        grid.innerHTML = '';
        if (!S.filtered.length) {
          empty.hidden = false;
          return;
        }
        empty.hidden = true;

        const frag = document.createDocumentFragment();
        S.filtered.forEach(function (r) {
          const card = document.createElement('article');
          card.className = 'card';
          card.setAttribute('data-recipe-id', r.id);

          const thumb = document.createElement('div');
          thumb.className = 'thumb';
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.src = r.thumb || 'assets/screenshots/placeholder.jpg';
          img.alt = r.title;
          thumb.appendChild(img);

          const play = document.createElement('div');
          play.className = 'play';
          const hasVideo = Boolean(r.videoId);
          play.innerHTML = hasVideo ? '<button type="button" data-video-id="'+ r.videoId +'">Guarda video</button>' : '<span class="sr-only">Nessun video</span>';
          thumb.appendChild(play);

          const body = document.createElement('div');
          body.className = 'body';
          const h3 = document.createElement('h3');
          h3.className = 'title';
          h3.textContent = r.title;
          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.textContent = r.tags.join(' · ');

          body.appendChild(h3);
          body.appendChild(meta);

          card.appendChild(thumb);
          card.appendChild(body);
          frag.appendChild(card);
        });
        grid.appendChild(frag);
      }

      // SW registration con update prompt semplice
      function registerSW() {
        if (!('serviceWorker' in navigator)) return;
        navigator.serviceWorker.register('service-worker.js?v=2025-10-27-2')
          .then(function (reg) {
            if (!reg) return;
            reg.addEventListener('updatefound', function () {
              const newSW = reg.installing;
              if (!newSW) return;
              newSW.addEventListener('statechange', function () {
                if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                  const ok = confirm('Aggiornamento disponibile. Ricaricare ora');
                  if (ok) location.reload();
                }
              });
            });
          })
          .catch(function (e) {
            if (window.debugTools) console.warn('SW register error', e && e.message);
          });
      }

      document.addEventListener('DOMContentLoaded', function () {
        init();
        registerSW();
      });
    })();
  </script>
</body>
</html>
