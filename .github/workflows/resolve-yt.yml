name: Resolve YouTube IDs
permissions:
contents: write

on:
workflow_dispatch:

jobs:
resolve:
runs-on: ubuntu-latest
timeout-minutes: 30
steps:
- name: Checkout
uses: actions/checkout@v4

  - name: Setup Node
    uses: actions/setup-node@v4
    with:
      node-version: "20"

  - name: Install deps
    run: npm ci || npm i

  - name: Run resolver
    run: LIMIT=30 node script/resolve-youtube-ids.mjs
    continue-on-error: true

  - name: Ensure output file exists
    run: |
      test -f assets/json/video_index.resolved.json || echo "[]" > assets/json/video_index.resolved.json
      echo "--- HEAD video_index.resolved.json ---"
      head -n 40 assets/json/video_index.resolved.json || true

  - name: Commit results
    run: |
      if [[ -n "$(git status --porcelain)" ]]; then
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add assets/json/video_index.resolved.json
        git commit -m "ci: update video_index.resolved.json"
        git push
      else
        echo "No changes"
      fi
